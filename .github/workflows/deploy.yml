name: Deploy to Production

on:
  push:
    branches: [ master ]
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================
  # Pre-deployment Checks
  # ==========================================
  pre-deploy-checks:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run security checks
        run: |
          pip install bandit
          bandit -r apps/ config/ -ll

      - name: Validate Django settings
        run: |
          cp .env.example .env
          echo "SECRET_KEY=validation-key" >> .env
          echo "DEBUG=False" >> .env
          python manage.py check --deploy

      - name: Check migrations
        run: |
          python manage.py makemigrations --check --dry-run --no-input

  # ==========================================
  # Build & Test
  # ==========================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: pre-deploy-checks

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_educore
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install coverage

      - name: Setup test environment
        run: |
          cp .env.example .env
          echo "SECRET_KEY=test-deployment-key" >> .env
          echo "DB_ENGINE=django.db.backends.postgresql" >> .env
          echo "DB_NAME=test_educore" >> .env
          echo "DB_USER=postgres" >> .env
          echo "DB_PASSWORD=postgres" >> .env
          echo "DB_HOST=localhost" >> .env
          echo "DB_PORT=5432" >> .env

      - name: Run tests
        run: |
          python manage.py migrate --no-input
          python manage.py test --no-input

      - name: Collect static files
        run: |
          python manage.py collectstatic --no-input

      - name: Create deployment package
        run: |
          mkdir -p deploy_package
          tar -czf deploy_package/educore-${{ github.sha }}.tar.gz \
            --exclude='.git' \
            --exclude='venv' \
            --exclude='.venv' \
            --exclude='*.pyc' \
            --exclude='__pycache__' \
            --exclude='*.log' \
            --exclude='db.sqlite3' \
            .

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deploy_package/educore-${{ github.sha }}.tar.gz
          retention-days: 7

  # ==========================================
  # Deploy to Staging (Auto)
  # ==========================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/master' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.educore.example.com

    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package

      - name: Deploy to Staging Server
        run: |
          echo "üöÄ Deploying to staging environment..."
          echo "üì¶ Package: educore-${{ github.sha }}.tar.gz"
          # Add your deployment commands here
          # Example: scp, rsync, or API calls to your hosting provider

          # SSH deployment example (commented):
          # - name: Deploy via SSH
          #   uses: appleboy/ssh-action@master
          #   with:
          #     host: ${{ secrets.STAGING_HOST }}
          #     username: ${{ secrets.STAGING_USER }}
          #     key: ${{ secrets.STAGING_SSH_KEY }}
          #     script: |
          #       cd /var/www/educore-staging
          #       tar -xzf educore-${{ github.sha }}.tar.gz
          #       source venv/bin/activate
          #       pip install -r requirements.txt
          #       python manage.py migrate --no-input
          #       python manage.py collectstatic --no-input
          #       sudo systemctl restart gunicorn-educore
          #       sudo systemctl restart celery-educore

      - name: Run smoke tests
        run: |
          echo "üß™ Running smoke tests on staging..."
          # Add smoke test commands
          # curl -f https://staging.educore.example.com/health/ || exit 1

      - name: Notify deployment success
        run: |
          echo "‚úÖ Staging deployment completed successfully"

  # ==========================================
  # Deploy to Production (Manual Approval)
  # ==========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-staging]
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://educore.example.com

    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package

      - name: Create backup
        run: |
          echo "üíæ Creating production backup..."
          # Add backup commands here
          # pg_dump, file backups, etc.

      - name: Deploy to Production Server
        run: |
          echo "üöÄ Deploying to PRODUCTION environment..."
          echo "üì¶ Package: educore-${{ github.sha }}.tar.gz"
          echo "‚ö†Ô∏è  Production deployment"
          # Add production deployment commands

      - name: Run database migrations
        run: |
          echo "üîÑ Running database migrations..."
          # python manage.py migrate --no-input

      - name: Health check
        run: |
          echo "üè• Running health checks..."
          # curl -f https://educore.example.com/health/ || exit 1

      - name: Notify team
        run: |
          echo "‚úÖ Production deployment completed!"
          echo "üéâ Version: ${{ github.ref_name }}"
          # Add Slack/Discord/Email notifications here

  # ==========================================
  # Post-Deployment Tasks
  # ==========================================
  post-deploy:
    name: Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()

    steps:
      - name: Update deployment status
        run: |
          echo "üìä Deployment status: ${{ needs.deploy-production.result }}"

      - name: Create GitHub release (if tagged)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            ## üöÄ EDU_SYS Release ${{ github.ref_name }}

            ### Changes
            See commit history for details.

            ### Deployment
            - ‚úÖ Staging deployed
            - ‚úÖ Production deployed

            ### Notes
            Deployed at: ${{ github.event.head_commit.timestamp }}
          draft: false
          prerelease: false

      - name: Cleanup old artifacts
        run: |
          echo "üßπ Cleaning up old deployment artifacts..."
