{% extends 'base.html' %}

{% block title %}لوحة التحكم{% endblock %}
{% block page_title %}لوحة التحكم{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="bi bi-people-fill"></i>
            </div>
            <div class="stat-number">{{ total_students }}</div>
            <div class="stat-label">إجمالي الطلاب</div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon green">
                <i class="bi bi-person-badge"></i>
            </div>
            <div class="stat-number">{{ total_teachers }}</div>
            <div class="stat-label">المدرسين</div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon yellow">
                <i class="bi bi-collection"></i>
            </div>
            <div class="stat-number">{{ total_groups }}</div>
            <div class="stat-label">المجموعات</div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="bi bi-calendar-check"></i>
            </div>
            <div class="stat-number">{{ today_attendances }}</div>
            <div class="stat-label">حضور اليوم</div>
        </div>
    </div>
</div>

<!-- Financial Summary -->
<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-label mb-2">المستحق هذا الشهر</div>
                    <div class="stat-number">{{ month_total_due|floatformat:0 }} ج.م</div>
                </div>
                <div class="stat-icon yellow">
                    <i class="bi bi-cash-stack"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <div class="stat-label mb-2">المحصل هذا الشهر</div>
                    <div class="stat-number text-success">{{ month_total_paid|floatformat:0 }} ج.م</div>
                </div>
                <div class="stat-icon green">
                    <i class="bi bi-wallet2"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance & Notifications Stats -->
<div class="row g-3 mb-4">
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>إحصائيات الحضور (آخر 7 أيام)</span>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="p-3">
                            <div class="fs-3 fw-bold text-success">{{ present_count }}</div>
                            <div class="text-muted">حاضر</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-3">
                            <div class="fs-3 fw-bold text-warning">{{ late_count }}</div>
                            <div class="text-muted">متأخر</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="p-3">
                            <div class="fs-3 fw-bold text-danger">{{ absent_count }}</div>
                            <div class="text-muted">غائب</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-whatsapp me-2"></i>إشعارات الواتساب</span>
                <a href="{% url 'reports:notifications' %}" class="btn btn-sm btn-outline-success">عرض الكل</a>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="p-3">
                            <div class="fs-3 fw-bold text-success">{{ today_notifications }}</div>
                            <div class="text-muted">رسائل اليوم</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3">
                            <div class="fs-3 fw-bold text-danger">{{ failed_notifications }}</div>
                            <div class="text-muted">فشل اليوم</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3">
    <!-- Recent Attendance -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>آخر تسجيلات الحضور</span>
                <a href="{% url 'reports:attendance' %}" class="btn btn-sm btn-outline-primary">عرض الكل</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>الطالب</th>
                                <th>المجموعة</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for att in recent_attendances %}
                            <tr>
                                <td>{{ att.student.full_name }}</td>
                                <td>{{ att.session.group.group_name }}</td>
                                <td>
                                    {% if att.status == 'present' %}
                                    <span class="badge bg-success">حاضر</span>
                                    {% elif att.status == 'late' %}
                                    <span class="badge bg-warning">متأخر</span>
                                    {% else %}
                                    <span class="badge bg-danger">غائب</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted py-4">لا توجد تسجيلات</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Payments -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>المدفوعات المعلقة</span>
                <a href="{% url 'payments:list' %}" class="btn btn-sm btn-outline-primary">عرض الكل</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>الطالب</th>
                                <th>المجموعة</th>
                                <th>المبلغ</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in pending_payments %}
                            <tr>
                                <td>{{ payment.student.full_name }}</td>
                                <td>{{ payment.group.group_name }}</td>
                                <td>{{ payment.amount_due|floatformat:0 }} ج.م</td>
                                <td>
                                    {% if payment.status == 'unpaid' %}
                                    <span class="badge bg-danger">غير مدفوع</span>
                                    {% else %}
                                    <span class="badge bg-warning">جزئي</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">لا توجد مدفوعات معلقة</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Notifications -->
<div class="row g-3 mt-2">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-whatsapp text-success me-2"></i>آخر الإشعارات المرسلة</span>
                <a href="{% url 'reports:notifications' %}" class="btn btn-sm btn-outline-success">عرض سجل الإشعارات</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 50px;">النوع</th>
                                <th>الطالب</th>
                                <th>الرسالة</th>
                                <th>الوقت</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for notification in recent_notifications %}
                            <tr>
                                <td><i class="{{ notification.type_icon }} fs-5"></i></td>
                                <td>{{ notification.student_name }}</td>
                                <td>
                                    <small class="text-muted">{{ notification.message|truncatechars:60 }}</small>
                                </td>
                                <td>
                                    <small>{{ notification.sent_at|date:"d/m H:i" }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-{{ notification.status_badge }}">
                                        {{ notification.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="bi bi-chat-dots fs-1 d-block mb-2"></i>
                                    لا توجد إشعارات مرسلة بعد
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
