{% extends "base.html" %}

{% block title %}تسجيل الحضور - {% endblock %}

{% block content %}
<div class="container-fluid py-4"
     x-data="scannerPageData"
     data-session-info="{{ group_name }} - {{ session_date|date:'Y-m-d' }}"
     data-session-id="{{ session_id }}"
     data-total-students="{{ total_students }}">
    
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-qr-code-scan"></i>
                        تسجيل الحضور
                    </h1>
                    <p class="text-muted mb-0" x-text="sessionInfo"></p>
                </div>
                <div class="no-print">
                    <button class="btn btn-outline-secondary" @click="window.print()">
                        <i class="bi bi-printer"></i> طباعة
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Session Info Card -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card info">
                <div class="card-body">
                    <div class="stat-icon">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div class="stat-value" x-text="stats.total">0</div>
                    <div class="stat-label">إجمالي الطلاب</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card success">
                <div class="card-body">
                    <div class="stat-icon">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div class="stat-value text-success" x-text="stats.present">0</div>
                    <div class="stat-label">حضور</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card warning">
                <div class="card-body">
                    <div class="stat-icon">
                        <i class="bi bi-clock-fill"></i>
                    </div>
                    <div class="stat-value text-warning" x-text="stats.late">0</div>
                    <div class="stat-label">تأخير</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card danger">
                <div class="card-body">
                    <div class="stat-icon">
                        <i class="bi bi-x-circle-fill"></i>
                    </div>
                    <div class="stat-value text-danger" x-text="stats.absent">0</div>
                    <div class="stat-label">غياب</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scanner Section -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-upc-scan"></i>
                        مسح الباركود
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Scanner Form with HTMX -->
                    <form 
                        hx-post="{% url 'attendance:htmx_api_scan' %}"
                        hx-target="#scan-result"
                        hx-swap="innerHTML"
                        hx-indicator="#scan-indicator"
                        @submit.prevent="isProcessing = true"
                        x-ref="scanForm">
                        
                        {% csrf_token %}
                        <input type="hidden" name="session_id" value="{{ session_id }}">
                        
                        <div class="mb-3">
                            <label for="barcode-input" class="form-label">
                                كود الطالب / الباركود
                            </label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">
                                    <i class="bi bi-upc"></i>
                                </span>
                                <input 
                                    type="text" 
                                    class="form-control scanner-input" 
                                    id="barcode-input"
                                    name="barcode"
                                    x-model="barcode"
                                    x-ref="barcodeInput"
                                    autocomplete="off"
                                    placeholder="امسح الباركود أو أدخل الكود..."
                                    required
                                    autofocus>
                                <button 
                                    type="submit" 
                                    class="btn btn-primary"
                                    :disabled="isProcessing || !barcode">
                                    <span class="htmx-indicator" id="scan-indicator">
                                        <span class="spinner-border spinner-border-sm"></span>
                                    </span>
                                    <span x-show="!isProcessing">مسح</span>
                                    <span x-show="isProcessing" x-cloak>جاري المعالجة...</span>
                                </button>
                            </div>
                            <div class="form-text">
                                استخدم قارئ الباركود أو أدخل كود الطالب واضغط Enter
                            </div>
                        </div>
                    </form>
                    
                    <!-- Scan Result Display -->
                    <div id="scan-result" class="mt-3"></div>
                </div>
            </div>
        </div>
        
        <!-- Recent Scans -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history"></i>
                        عمليات المسح الأخيرة
                    </h5>
                    <span class="badge bg-secondary" x-text="recentScans.length + ' / ' + maxRecentScans"></span>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                        <template x-for="scan in recentScans" :key="scan.id">
                            <div class="list-group-item recent-scans-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1" x-text="scan.student_name"></h6>
                                        <small class="text-muted" x-text="scan.time"></small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge" 
                                              :class="getStatusBadgeClass(scan.status)"
                                              x-text="getStatusText(scan.status)">
                                        </span>
                                    </div>
                                </div>
                                <div x-show="scan.message" class="mt-2">
                                    <small class="text-muted" x-text="scan.message"></small>
                                </div>
                            </div>
                        </template>
                        <div x-show="recentScans.length === 0" class="text-center py-4 text-muted">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            لا توجد عمليات مسح بعد
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Attendance List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list-check"></i>
                        قائمة الحضور
                    </h5>
                    <div>
                        <input 
                            type="search" 
                            class="form-control form-control-sm" 
                            placeholder="بحث عن طالب..."
                            x-model="searchQuery"
                            style="width: 250px;">
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>كود الطالب</th>
                                    <th>اسم الطالب</th>
                                    <th>الحالة المالية</th>
                                    <th>وقت المسح</th>
                                    <th>الحالة</th>
                                    <th class="no-print">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-list"
                                   hx-get="{% url 'attendance:htmx_api_session_attendance' session_id %}"
                                   hx-trigger="load, every 5s"
                                   hx-swap="innerHTML">
                                <!-- Loaded via HTMX -->
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">جاري التحميل...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>

<!-- HTMX Response Template (for partial updates) -->
<template id="scan-result-success">
    <div class="alert alert-success alert-dismissible fade show scanner-result success" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-check-circle-fill fs-4 me-3"></i>
            <div>
                <h5 class="alert-heading mb-1">${student_name}</h5>
                <p class="mb-1">${message}</p>
                <small class="text-muted">${time}</small>
            </div>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
        </div>
    </div>
</template>

<template id="scan-result-error">
    <div class="alert alert-danger alert-dismissible fade show scanner-result error" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-x-circle-fill fs-4 me-3"></i>
            <div>
                <h5 class="alert-heading mb-1">خطأ</h5>
                <p class="mb-0">${message}</p>
            </div>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
        </div>
    </div>
</template>

<template id="scan-result-warning">
    <div class="alert alert-warning alert-dismissible fade show scanner-result warning" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
            <div>
                <h5 class="alert-heading mb-1">${student_name}</h5>
                <p class="mb-1">${message}</p>
                <small class="text-muted">${time}</small>
            </div>
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
        </div>
    </div>
</template>

{% endblock %}

{% block page_scripts %}
<script>
// Scanner page data - extends the base scannerData
document.addEventListener('alpine:init', () => {
    Alpine.data('scannerPageData', () => ({
        // Basic scanner data
        barcode: '',
        isProcessing: false,
        recentScans: [],
        maxRecentScans: 10,
        
        // Session info
        sessionInfo: '',
        sessionId: null,
        
        // Statistics
        stats: {
            total: 0,
            present: 0,
            late: 0,
            absent: 0
        },
        
        // Search
        searchQuery: '',
        
        init() {
            // Get data from DOM
            const container = this.$el;
            this.sessionInfo = container.dataset.sessionInfo || '';
            this.sessionId = parseInt(container.dataset.sessionId) || null;
            this.stats.total = parseInt(container.dataset.totalStudents) || 0;
            
            // Focus on input
            this.$nextTick(() => {
                this.$refs.barcodeInput?.focus();
            });
            
            // Listen for HTMX events
            document.body.addEventListener('htmx:afterRequest', (event) => {
                if (event.detail.target?.id === 'scan-result') {
                    this.isProcessing = false;
                    
                    try {
                        const response = JSON.parse(event.detail.xhr.responseText);
                        
                        if (response.student_name) {
                            this.addRecentScan({
                                id: Date.now(),
                                student_name: response.student_name,
                                status: response.status || 'present',
                                time: new Date().toLocaleTimeString('ar-EG'),
                                message: response.message
                            });
                            
                            // Play sound
                            if (typeof playSound === 'function') {
                                playSound(response.status === 'blocked' ? 'error' : 'success');
                            }
                        }
                        
                        // Update stats
                        if (response.stats) {
                            this.stats = { ...this.stats, ...response.stats };
                        }
                    } catch (e) {
                        // Not JSON response
                    }
                    
                    // Clear input
                    this.clearInput();
                }
            });
        },
        
        clearInput() {
            this.barcode = '';
            this.$refs.barcodeInput?.focus();
        },
        
        addRecentScan(scan) {
            this.recentScans.unshift(scan);
            if (this.recentScans.length > this.maxRecentScans) {
                this.recentScans.pop();
            }
        },
        
        getStatusBadgeClass(status) {
            const classes = {
                present: 'bg-success',
                late: 'bg-warning text-dark',
                absent: 'bg-danger',
                blocked: 'bg-secondary'
            };
            return classes[status] || 'bg-secondary';
        },
        
        getStatusText(status) {
            const texts = {
                present: 'حاضر',
                late: 'متأخر',
                absent: 'غائب',
                blocked: 'ممنوع'
            };
            return texts[status] || status;
        }
    }));
});
</script>
{% endblock %}
